<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Raleway:wght@700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-sub: #6b7280;
            --accent-gold: #f59e0b;
            --accent-silver: #9ca3af;
            --accent-bronze: #b45309;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
        }

        h1 {
            font-weight: 800;
            font-size: 2.5rem;
            margin: 0;
            color: var(--text-main);
            letter-spacing: -0.025em;
        }

        .company-logo {
            font-family: 'Raleway', sans-serif;
            font-weight: 700;
            font-size: 2rem;
            margin-bottom: 20px;
            text-transform: lowercase;
            line-height: 1;
        }

        .company {
            color: #FF6600;
        }

        .name {
            color: #B3B3B3;
        }

        #loader {
            text-align: center;
            font-size: 1.2rem;
            color: var(--text-sub);
            padding: 40px;
        }

        .spinner {
            display: inline-block;
            width: 28px;
            height: 28px;
            border: 3px solid #e5e7eb;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .grid.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        /* Universal Card Styling (Unified Border) */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            /* Uniform border for all */
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden;
        }



        /* Rank Badge */
        .rank-badge {
            position: absolute;
            top: 10px;
            left: 12px;
            font-weight: 800;
            font-size: 1.125rem;
            color: #d1d5db;
            z-index: 10;
            line-height: 1;
        }



        /* Profile Image */
        .avatar-container {
            width: 60px;
            height: 60px;
            margin-bottom: 12px;
            border-radius: 50%;
            overflow: hidden;
            background-color: #e0e7ff;
            border: 2px solid #fff;
            box-shadow: 0 0 0 1px #e5e7eb;
        }

        .avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .name {
            font-weight: 600;
            font-size: 1rem;
            margin: 0 0 2px 0;
            color: var(--text-main);
            line-height: 1.4;
        }



        .date-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .date-pill {
            background-color: #eff6ff;
            color: var(--primary-color);
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .date-text {
            font-size: 0.75rem;
            color: var(--text-sub);
            margin-top: 4px;
        }

        /* Error Message */
        .error {
            color: #ef4444;
            background: #fef2f2;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .empty-message {
            text-align: center;
            width: 100%;
            grid-column: 1 / -1;
            padding: 40px;
            background: white;
            border-radius: 12px;
            color: var(--text-sub);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="company-logo">
                <span class="company">company</span><span class="name">name</span>
            </div>
            <h1>Tenure Leaderboard</h1>
        </header>

        <div id="loader">
            <div class="spinner"></div><br>Loading employee data...
        </div>
        <div id="error" class="error"></div>

        <div id="grid" class="grid">
            <!-- Cards will be injected here -->
        </div>
    </div>

    <script>
        // HTML-escape helper to prevent XSS from user-controlled data
        function escapeHtml(str) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // Initialize â€” single server call for both data and photos
        window.onload = function () {
            if (typeof google !== 'undefined' && google.script) {
                google.script.run
                    .withSuccessHandler(renderPage)
                    .withFailureHandler(showError)
                    .getPageData();
            } else {
                // Fallback for Canvas Preview (Mock Data)
                setTimeout(function () {
                    renderPage({
                        data: [
                            { name: "Sarah Connors", email: "sarah@example.com", rank: 1, formattedDate: "Jan 12, 2015", tenure: "11 years, 1 month" },
                            { name: "Kyle Reese", email: "kyle@example.com", rank: 2, formattedDate: "Mar 04, 2018", tenure: "7 years, 11 months" }
                        ],
                        photos: {},
                        logs: ["Mock Mode"]
                    });
                }, 800);
            }
        };

        function renderPage(response) {
            var loader = document.getElementById('loader');
            var grid = document.getElementById('grid');
            var errorDiv = document.getElementById('error');

            var employees = response.data || [];
            var photos = response.photos || {};
            var logs = response.logs || [];

            loader.style.display = 'none';

            // Show API warnings if any
            if (logs.length > 0) {
                var apiErrors = logs.filter(function (l) { return l.indexOf("failed") >= 0 || l.indexOf("NOT enabled") >= 0; });
                if (apiErrors.length > 0) {
                    errorDiv.style.display = 'block';
                    errorDiv.innerHTML = '<div style="font-size:0.9em; opacity:0.8"><strong>Photo Debug:</strong><br>' + escapeHtml(apiErrors.join(', ')) + '</div>';
                }
            }

            setTimeout(function () { grid.classList.add('loaded'); }, 100);

            if (!employees || employees.length === 0) {
                grid.innerHTML = '<div class="empty-message">No employees found in the "TenureRank" tab.<br><small>Check that columns A (Email) and B (Start Date) have data.</small></div>';
                return;
            }

            var html = employees.map(function (emp) {
                var safeName = escapeHtml(emp.name);
                var safeEmail = escapeHtml(emp.email);
                var safeTenure = escapeHtml(emp.tenure || '');
                var safeDate = escapeHtml(emp.formattedDate || '');

                // Use real photo if available, otherwise fall back to generated avatar
                var photoUrl = photos[emp.email];
                var avatarSrc = photoUrl || ('https://ui-avatars.com/api/?name=' + encodeURIComponent(emp.name) + '&background=e0e7ff&color=4f46e5');

                var rankClass = '';
                if (emp.rank === 1) rankClass = 'rank-1';
                else if (emp.rank === 2) rankClass = 'rank-2';
                else if (emp.rank === 3) rankClass = 'rank-3';

                return '<div class="card ' + rankClass + '">' +
                    '<div class="rank-badge">#' + emp.rank + '</div>' +
                    '<div class="avatar-container">' +
                    '<img class="avatar" src="' + avatarSrc + '" alt="' + safeName + '">' +
                    '</div>' +
                    '<h3 class="name">' + safeName + '</h3>' +
                    '<div class="date-container">' +
                    '<div class="date-pill">' + safeTenure + '</div>' +
                    '<div class="date-text">' + safeDate + '</div>' +
                    '</div>' +
                    '</div>';
            }).join('');

            grid.innerHTML = html;
        }

        function showError(error) {
            var loader = document.getElementById('loader');
            var errorDiv = document.getElementById('error');
            loader.style.display = 'none';
            errorDiv.style.display = 'block';
            errorDiv.textContent = 'Error loading data: ' + error.message;
        }
    </script>
</body>

</html>
